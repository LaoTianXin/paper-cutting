# 📸 智能拍照系统使用指南

## 功能概述

智能拍照系统是一个整合了全身识别、手势识别和自动拍照的完整解决方案。该系统通过多阶段状态机实现智能化的拍照流程。

## 核心功能

### 1. 全身识别阶段
- **目的**：确保画面中只有一人，且完整身体在画面内
- **要求**：
  - 必须只检测到一人
  - 全身需要在画面中保持至少 1 秒
  - 如果超过 1 秒未检测到全身，系统会自动重置

### 2. 手势识别阶段
- **目的**：通过 OK 手势确认准备拍照
- **要求**：
  - 做出标准 OK 手势（大拇指和食指形成圆圈，其他手指伸直）
  - 保持手势 3 秒
  - 在此期间仍需保持全身在画面中

### 3. 倒计时阶段
- **目的**：给用户准备时间，调整姿势
- **特点**：
  - 5 秒倒计时
  - 屏幕显示大号数字
  - 继续追踪全身位置

### 4. 拍照阶段
- **目的**：自动截取并放大全身照片
- **特点**：
  - 基于最后一次成功识别的全身位置进行截取
  - 自动添加边距
  - 放大 1.5 倍显示
  - 可下载保存

## 状态机流程

```
IDLE (等待开始)
  ↓
DETECTING_BODY (检测全身中) - 持续 1 秒
  ↓
BODY_DETECTED (已识别全身) - 显示确认信息 1.5 秒
  ↓
DETECTING_GESTURE (等待手势) - 等待 OK 手势
  ↓
GESTURE_DETECTED (检测到 OK 手势) - 保持 3 秒
  ↓
COUNTDOWN (倒计时中) - 5 秒倒计时
  ↓
CAPTURE (正在拍照) - 截取并处理图像
  ↓
COMPLETED (拍照完成) - 显示结果和操作按钮
```

## 重置条件

系统会在以下情况自动重置到初始状态：

1. **全身检测阶段**：超过 1 秒未检测到全身
2. **手势识别阶段**：超过 1 秒未检测到全身（即使手势正确）
3. **用户主动取消**：点击"取消并重新开始"按钮

## 使用步骤

### 步骤 1：全身识别
1. 站在摄像头前，确保整个身体在画面中
2. 保持静止 1 秒以上
3. 确保只有一人在画面中
4. 系统会显示绿色边框和"✓ 已识别到全身"提示

⚠️ **注意**：
- 如果检测到多人，会显示警告提示
- 如果超过 1 秒未检测到完整身体，需要重新开始

### 步骤 2：OK 手势确认
1. 做出标准 OK 手势：
   - 大拇指和食指形成圆圈
   - 中指、无名指、小指伸直向上
2. 保持手势 3 秒
3. 屏幕会显示倒计时提示："保持 OK 手势 3s"

⚠️ **注意**：
- 如果手势中断，需要重新开始手势识别
- 在此期间仍需保持全身在画面中

### 步骤 3：倒计时准备
1. 手势确认后，系统进入 5 秒倒计时
2. 屏幕中央会显示大号倒计时数字（5、4、3、2、1）
3. 利用这段时间调整姿势和表情

💡 **提示**：保持姿势稳定，确保拍照效果

### 步骤 4：查看和保存
1. 倒计时结束后自动拍照
2. 右侧显示截取并放大的全身照片
3. 可以：
   - 点击"⬇️ 下载照片"保存图片
   - 点击"🔄 重新拍照"重新开始流程

## 界面说明

### 状态面板
显示当前所处阶段：
- **等待开始** - 灰色
- **检测全身中** - 蓝色（闪烁）
- **已识别全身** - 绿色
- **等待手势** - 橙色（闪烁）
- **检测到 OK 手势** - 紫色
- **倒计时中** - 红色（快速闪烁）
- **正在拍照** - 青色
- **拍照完成** - 绿色（庆祝动画）

### 使用流程指示
4 个步骤卡片，显示当前进度：
- 当前步骤：蓝色高亮
- 已完成步骤：绿色标记
- 未完成步骤：灰色

### 视频预览
- 左侧：实时摄像头画面
- 显示检测框、手势标识和状态提示
- 倒计时时显示大号数字

### 拍照结果（完成后）
- 右侧：截取的全身照片（放大 1.5 倍）
- 操作按钮：下载和重新拍照

## 技术实现

### 使用的技术栈
1. **OpenCV.js**：全身检测（Haar Cascade）
2. **MediaPipe Hands**：手势识别
3. **React Hooks**：状态管理
4. **Canvas API**：图像处理和渲染

### 核心算法

#### 全身检测
```typescript
// 使用 Haar Cascade 分类器
fullBodyCascade.detectMultiScale(
  gray,
  bodies,
  1.05,      // scaleFactor: 图像金字塔缩放比例
  3,         // minNeighbors: 候选框保留阈值
  0,         // flags
  new cv.Size(50, 100),  // minSize: 最小检测尺寸
  msize      // maxSize
);
```

#### OK 手势识别
检查条件：
1. 大拇指尖和食指尖距离 < 0.08（形成圆圈）
2. 中指、无名指、小指在手掌中心上方（伸直）
3. 食指弯曲（形成圆圈的一部分）

#### 图像截取和放大
```typescript
// 1. 获取最后识别的全身区域
// 2. 添加 20px 边距
// 3. 截取图像数据
// 4. 放大 1.5 倍
// 5. 渲染到 Canvas
```

## 常见问题

### Q: 为什么检测不到全身？
A: 
- 确保整个身体（从头到脚）都在画面中
- 保持适当距离，不要太近或太远
- 确保光线充足
- 背景简单，避免复杂背景干扰

### Q: 为什么 OK 手势识别失败？
A:
- 确保大拇指和食指形成清晰的圆圈
- 其他三根手指要伸直向上
- 手势要完整清晰，不要被遮挡
- 保持手势稳定 3 秒

### Q: 为什么系统突然重置？
A:
- 检查是否全身离开画面超过 1 秒
- 确保始终只有一人在画面中
- 在手势识别阶段也需要保持全身在画面内

### Q: 拍照位置不准确怎么办？
A:
- 系统使用最后一次识别的全身位置
- 在倒计时期间保持姿势稳定
- 确保全身完整在画面中
- 如果不满意，可以重新拍照

### Q: 如何获得最佳拍照效果？
A:
- 光线充足且均匀
- 背景简单整洁
- 站在画面中央
- 保持自然站姿
- 距离适中（建议 2-3 米）

## 性能优化

### 帧率控制
- MediaPipe Camera 自动控制帧率
- 建议摄像头分辨率：640x480

### 内存管理
- OpenCV Mat 对象及时释放（.delete()）
- 避免内存泄漏

### 响应式设计
- 支持桌面端和移动端
- 自适应屏幕尺寸

## 浏览器兼容性

### 推荐浏览器
- Chrome 90+
- Edge 90+
- Firefox 88+
- Safari 14+

### 必需功能
- WebRTC（摄像头访问）
- WebAssembly（OpenCV.js）
- Canvas API
- ES6+ 支持

## 隐私说明

- 所有处理均在本地浏览器完成
- 不上传任何图像或视频数据到服务器
- 不存储个人信息
- 摄像头权限仅用于实时检测和拍照

## 更新日志

### v1.0.0 (当前版本)
- ✅ 实现全身识别（持续 1 秒）
- ✅ 实现 OK 手势识别（保持 3 秒）
- ✅ 实现 5 秒倒计时
- ✅ 实现自动拍照和截图
- ✅ 实现全身丢失检测和自动重置
- ✅ 添加状态面板和流程指示
- ✅ 支持下载照片
- ✅ 响应式设计

## 开发者说明

### 组件结构
```
IntegratedPhotoCapture.tsx
├── 状态管理 (useState, useRef)
├── 全身检测逻辑 (detectFullBody)
├── 手势识别逻辑 (recognizeOKGesture)
├── 绘制逻辑 (drawFrame, onHandsResults)
├── 倒计时逻辑 (useEffect - countdown)
├── 拍照逻辑 (useEffect - capture)
└── UI 渲染
```

### 状态枚举
```typescript
enum CaptureState {
  IDLE,
  DETECTING_BODY,
  BODY_DETECTED,
  DETECTING_GESTURE,
  GESTURE_DETECTED,
  COUNTDOWN,
  CAPTURE,
  COMPLETED
}
```

### 关键 Refs
- `bodyDetectionStartTime`: 开始检测全身的时间
- `lastBodyDetectedTime`: 最后一次检测到全身的时间
- `gestureDetectionStartTime`: 开始检测手势的时间
- `lastBodyRectRef`: 最后识别的全身位置
- `fullBodyCascadeRef`: Haar Cascade 分类器实例

## 总结

智能拍照系统通过整合多种 AI 技术，实现了一个完全自动化的拍照流程：

1. **智能检测**：自动识别全身和手势
2. **容错机制**：多重检测和自动重置
3. **用户友好**：清晰的状态提示和流程指示
4. **高质量输出**：精准截取和放大全身照片

适用于：
- 自助拍照机
- 证件照采集
- 虚拟试衣间
- 体态评估
- 健身记录

欢迎使用！🎉

