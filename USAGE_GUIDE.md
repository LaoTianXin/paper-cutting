# 🎭 人脸检测应用 - 完整使用指南

## 🚀 快速开始

```bash
# 安装依赖
pnpm install

# 启动开发服务器
pnpm dev

# 访问应用
浏览器打开: http://localhost:3000
```

---

## 🎯 三种检测模式

### 1️⃣ 📹 摄像头模式（实时检测）

**适合场景**：演示、体验实时人脸检测

**特点**：
- ✅ 实时检测视频流中的人脸
- ✅ 支持前置/后置摄像头
- ✅ 镜像显示
- ✅ 自动持续检测

**使用方法**：
1. 点击顶部 **"📹 摄像头"** 按钮
2. 允许浏览器访问摄像头
3. 自动开始实时人脸检测

---

### 2️⃣ 📸 图片模式

**适合场景**：测试特定图片、调试、分享结果

**特点**：
- ✅ 上传图片或拍照
- ✅ 自动检测人脸
- ✅ 原图与检测结果对比显示
- ✅ 支持 JPG、PNG、WebP 等格式

**使用方法**：
1. 点击顶部 **"📸 图片"** 按钮
2. 点击 **"📷 上传图片测试"**
3. 选择文件或拍照
4. 自动显示检测结果

**手机使用**：
- 点击上传按钮会提示"拍照"或"从相册选择"
- 拍照后立即显示检测结果
- 可以反复测试不同图片

---

### 3️⃣ 🎬 视频模式（新！）

**适合场景**：分析视频内容、批量测试、录制演示

**特点**：
- ✅ 支持上传视频文件
- ✅ 逐帧人脸检测
- ✅ 实时显示 FPS
- ✅ 支持暂停/继续
- ✅ 原视频与检测结果并排显示
- ✅ 支持 MP4、MOV、AVI、WebM 等格式

**使用方法**：
1. 点击顶部 **"🎬 视频"** 按钮
2. 点击 **"🎬 上传视频测试"**
3. 选择视频文件或录制视频
4. 点击 **"▶️ 播放检测"** 开始处理
5. 实时查看检测结果

**控制按钮**：
- **▶️ 播放检测**：开始逐帧检测
- **⏸️ 暂停**：暂停检测
- **🔄 重新开始**：回到视频开头

**性能指标**：
- 显示实时 FPS（每秒处理帧数）
- 自动控制帧率为 30 FPS
- 处理速度取决于视频分辨率和设备性能

---

## 📱 手机测试指南

### 方法 1：手机浏览器直接访问

**步骤**：

1. **启动服务器**
   ```bash
   pnpm dev
   ```

2. **查看电脑 IP**
   ```bash
   # Windows
   ipconfig
   
   # Mac/Linux
   ifconfig | grep "inet "
   ```
   找到类似 `192.168.x.x` 的地址

3. **手机访问**
   - 确保手机和电脑在同一 WiFi
   - 手机浏览器输入：`http://你的IP:3000`
   - 例如：`http://192.168.1.100:3000`

4. **开始使用**
   - 摄像头模式：允许摄像头权限后自动检测
   - 图片模式：可以拍照或选择相册图片
   - 视频模式：可以录制或选择视频文件

### 推荐模式（手机）

| 模式 | 适合场景 | 需要权限 |
|-----|---------|---------|
| 📸 图片 | ⭐ 最推荐 | 相机/相册 |
| 🎬 视频 | 录制演示 | 相机/相册 |
| 📹 摄像头 | 实时体验 | 摄像头 |

---

## 🎨 界面说明

### 模式切换栏
```
┌─────────────────────────────────┐
│  📹 摄像头  │  📸 图片  │  🎬 视频  │
└─────────────────────────────────┘
```
点击按钮即可切换模式（高亮显示当前模式）

### 加载状态
```
⏳ Loading Haar-cascade face model...
```
等待模型加载完成后才能使用检测功能

### 检测结果
- 蓝色矩形框：标记检测到的人脸位置
- FPS 显示：视频模式下显示处理速度
- 并排对比：图片/视频模式下可以对比原始和检测结果

---

## ⚡ 性能优化建议

### 图片模式
- ✅ 使用中等分辨率图片（推荐 1920x1080 以下）
- ✅ 较大的图片会处理较慢但不影响使用
- ✅ 人脸占比越大，检测越准确

### 视频模式
- ✅ **推荐视频长度**：30 秒以内
- ✅ **推荐分辨率**：720p (1280x720) 或更低
- ✅ **最佳格式**：MP4 (H.264 编码)

**如果卡顿**：
1. 使用较短的视频片段
2. 降低视频分辨率
3. 尝试压缩视频文件

### 摄像头模式
- 默认已优化为最佳性能
- 如需调整，可修改代码中的 `videoConstraints`

---

## 🐛 常见问题

### Q1: 模型加载失败
**可能原因**：
- 网络问题
- 文件路径错误

**解决方案**：
- 检查 `public/models/` 目录下是否有 XML 文件
- 查看浏览器控制台的错误信息
- 刷新页面重新加载

### Q2: 检测不到人脸
**可能原因**：
- 人脸角度太大（侧脸）
- 人脸被遮挡
- 光线太暗
- 人脸太小

**建议**：
- ✅ 使用正面人脸照片
- ✅ 确保光线充足
- ✅ 人脸占据画面一定比例（至少 1/4）
- ✅ 避免遮挡物（口罩、墨镜、手）

### Q3: 视频检测很慢
**解决方案**：
- 使用较小分辨率的视频
- 缩短视频长度
- 检查设备性能（CPU 使用率）

### Q4: 手机无法访问
**检查事项**：
- ✅ 手机和电脑在同一 WiFi
- ✅ IP 地址正确
- ✅ 端口号是 3000
- ✅ 电脑防火墙允许 3000 端口
- ✅ 开发服务器正在运行

### Q5: 手机浏览器不允许摄像头
**解决方案**：
- 切换到 **图片模式** 或 **视频模式**
- 检查浏览器权限设置
- 使用 Chrome 或 Safari 浏览器

---

## 📊 支持的文件格式

### 图片格式
- ✅ JPG / JPEG
- ✅ PNG
- ✅ WebP
- ✅ GIF（静态）
- ✅ 浏览器支持的其他图片格式

### 视频格式
- ✅ MP4 (推荐)
- ✅ WebM
- ✅ MOV
- ✅ AVI
- ✅ MKV
- ✅ 浏览器支持的其他视频格式

**注意**：不同浏览器支持的格式可能有所不同

---

## 🔒 隐私说明

- ✅ **完全本地处理**：所有图片/视频处理都在浏览器本地完成
- ✅ **不上传服务器**：你的图片和视频不会上传到任何服务器
- ✅ **不存储数据**：关闭页面后所有数据自动清除
- ✅ **开源透明**：所有代码都可以查看和审计

---

## 🎓 技术细节

### 检测算法
- **Haar Cascade Classifier**：基于特征的快速人脸检测
- **训练数据**：正面人脸数据集
- **检测速度**：实时（毫秒级）
- **准确率**：中等（适合正面人脸）

### 处理流程

**图片模式**：
```
上传图片 → 加载到 Canvas → OpenCV 处理 → 绘制矩形框 → 显示结果
```

**视频模式**：
```
上传视频 → 播放视频 → 逐帧捕获 → OpenCV 处理 → Canvas 显示 → 循环
```

**摄像头模式**：
```
获取摄像头流 → 截取帧 → OpenCV 处理 → Canvas 显示 → requestAnimationFrame 循环
```

### 帧率控制（视频模式）
- **目标帧率**：30 FPS
- **实际帧率**：取决于设备性能
- **自动调节**：根据处理速度动态调整

---

## 🌟 最佳实践

### 测试建议

1. **先测试图片模式**
   - 确保模型正常工作
   - 了解检测效果和限制
   - 测试各种类型的人脸图片

2. **再测试视频模式**
   - 使用短视频（5-10秒）
   - 观察 FPS 和性能
   - 调整视频质量

3. **最后测试摄像头模式**
   - 体验实时检测
   - 演示和展示用

### 拍照技巧

为了获得最佳检测效果：
- ✅ 正面拍摄
- ✅ 光线充足
- ✅ 人脸清晰
- ✅ 避免极端角度
- ✅ 避免过度遮挡

### 视频录制建议

- ✅ 使用手机后置摄像头（画质更好）
- ✅ 保持稳定（使用三脚架）
- ✅ 确保人脸占据适当比例
- ✅ 避免快速移动
- ✅ 录制较短的片段便于测试

---

## 🚀 进阶使用

### 调整检测参数

如需调整检测敏感度，可修改 `haarFaceDetection.ts`：

```typescript
faceCascade.detectMultiScale(
  gray,
  faces,
  1.1,  // 缩放因子：值越小检测越慢但越准确
  3,    // 最小邻居数：值越大误检越少但可能漏检
  0,
  msize,
  msize
);
```

### 切换摄像头（手机）

修改 `App.tsx` 中的 `videoConstraints`：

```typescript
videoConstraints={{
  facingMode: "user"        // 前置摄像头
  // facingMode: "environment"  // 后置摄像头
}}
```

---

## 📞 获取帮助

遇到问题？

1. 查看浏览器控制台（按 F12）的错误信息
2. 检查网络连接
3. 确认模型文件已加载
4. 尝试不同的浏览器
5. 查看本文档的"常见问题"部分

---

## 🎉 开始使用

```bash
pnpm dev
```

**电脑访问**：http://localhost:3000  
**手机访问**：http://你的IP:3000

祝你测试愉快！🚀

